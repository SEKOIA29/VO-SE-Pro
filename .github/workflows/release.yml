name: "ğŸš€ Release VO-SE  Pro (Official Edition)"

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 1. å…ˆã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          python -m pip uninstall -y pkg_resources || true
          python -m pip install "setuptools>=70,<81" "pyinstaller==6.13.0"
          pip install PySide6 numpy sounddevice soundfile mido janome Pillow ruff pyright scipy onnxruntime chardet pykakasi backports.tarfile
          pip install pyopenjtalk --only-binary :all: || pip install pyopenjtalk

      - name: Verify pkg_resources for PyInstaller hook
        shell: python
        run: |
          import pkg_resources
          print("pkg_resources file:", getattr(pkg_resources, "__file__", "unknown"))
          print("has NullProvider:", hasattr(pkg_resources, "NullProvider"))
          if not hasattr(pkg_resources, "NullProvider"):
              raise SystemExit("pkg_resources.NullProvider is missing")

      # --- ã“ã“ã‚’ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œã«ä¿®æ­£ï¼ˆä¸€åˆ‡ã®çœç•¥ãªã—ï¼‰ ---
      - name: Create User Dictionary (if needed)
        shell: python # ã‚·ã‚§ãƒ«ã«pythonã‚’ç›´æ¥æŒ‡å®šã™ã‚‹ã“ã¨ã§ã‚¨ãƒ©ãƒ¼ã‚’å›é¿
        run: |
          import os
          try:
              import pyopenjtalk
              if hasattr(pyopenjtalk, 'create_user_dict') and os.path.exists('user.csv'):
                  pyopenjtalk.create_user_dict('user.dic', 'user.csv')
                  print('User dictionary created successfully.')
              else:
                  print('Skip dict creation: No user.csv or function missing')
          except Exception as e:
              print(f'Skip dict creation: {e}')

      # 2. ãã®å¾Œã« Ruff ã§ãƒã‚§ãƒƒã‚¯
      - name: Lint with Ruff
        run: |
          ruff check . --select E,F --ignore E501

      # 3. æœ€å¾Œã« Pyright ã§ãƒã‚§ãƒƒã‚¯
      - name: Type Check with Pyright
        run: |
          pyright .

      - name: Pack Official Voice Data
        run: python modules/tools/pack_voice.py

      - name: Build C++ Engine
        shell: bash
        run: |
          mkdir -p bin
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            g++ -std=c++17 -shared -fPIC -o bin/libvo_se.dll src/vose_core.cpp src/world/*.cpp \
              -I. -Isrc -Iinclude -Iinclude/world -O2 -static-libgcc -static-libstdc++
          else
            clang++ -std=c++17 -shared -fPIC -o bin/libvo_se.dylib src/vose_core.cpp src/world/*.cpp \
              -I. -Isrc -Iinclude -Iinclude/world -undefined dynamic_lookup -O3 -w
          fi

      - name: Package App
        shell: bash
        run: |
          rm -rf dist build dist_out
          mkdir dist_out

          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            pyinstaller --noconsole --onefile --clean \
              --paths . \
              --paths modules \
              --icon="assets/icon.ico" \
              --hidden-import=modules.gui.main_window \
              --hidden-import=backports \
              --hidden-import=backports.tarfile \
              --add-data "bin/libvo_se.dll;bin" \
              --add-data "assets;assets" \
              --add-data "modules;modules" \
              --name "VO-SE_PRO_Win" main.py

            cp dist/VO-SE_PRO_Win.exe dist_out/
          else
            pyinstaller --noconsole --windowed --clean \
              --paths . \
              --paths modules \
              --icon="assets/icon.icns" \
              --exclude-module PySide6.QtPdf \
              --hidden-import=modules.gui.main_window \
              --hidden-import=backports \
              --hidden-import=backports.tarfile \
              --add-data "bin/libvo_se.dylib:bin" \
              --add-data "assets:assets" \
              --add-data "modules:modules" \
              --name "VO-SE_PRO_Mac" main.py

            chmod +x dist/VO-SE_PRO_Mac.app/Contents/MacOS/VO-SE_PRO_Mac
            cd dist && zip -ry ../dist_out/VO-SE_PRO_Mac.zip VO-SE_PRO_Mac.app && cd ..
          fi

      - name: ğŸ Verify and Fix macOS Library Linkage (Complete & Final)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          set +e
          echo "Macã®ãƒã‚¤ãƒŠãƒªæ¨©é™ä»˜ä¸ã¨ãƒªãƒ³ã‚¯ä¿®æ­£ã‚’å®Œå…¨å®Ÿè¡Œã—ã¾ã™..."
          
          # 1. ã‚¢ãƒ—ãƒªæœ¬ä½“ã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®š
          APP_BIN=$(find dist -name "VO-SE_PRO_Mac" -type f | grep "\.app/Contents/MacOS/VO-SE_PRO_Mac" | head -n 1)
          echo "Main Binary found at: $APP_BIN"

          # 2. æœ¬ä½“ã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸
          chmod +x "$APP_BIN"

          # 3. ã™ã¹ã¦ã® dylib ã«å¯¾ã—ã¦ä¸€æ‹¬å‡¦ç†
          # findã®çµæœã‚’ç¢ºå®Ÿã«1ã¤ãšã¤å‡¦ç†ã™ã‚‹ãŸã‚ã«while readã‚’ä½¿ç”¨
          find dist -name "libvo_se.dylib" -type f | while read -r DYLIB_BIN; do
            echo "--- Processing: $DYLIB_BIN ---"
            
            # æ¨©é™ã‚’æœ€å¼·ã®755ï¼ˆèª­ã¿ãƒ»æ›¸ããƒ»å®Ÿè¡Œï¼‰ã«è¨­å®š
            chmod 755 "$DYLIB_BIN"
            
            # dylibè‡ªèº«ã®å†…éƒ¨åã‚’ã€Œãƒ•ã‚¡ã‚¤ãƒ«åã ã‘ã€ã«æ›¸ãæ›ãˆã¦ã©ã“ã‹ã‚‰ã§ã‚‚å‘¼ã¹ã‚‹ã‚ˆã†ã«ã™ã‚‹
            LIB_NAME=$(basename "$DYLIB_BIN")
            install_name_tool -id "$LIB_NAME" "$DYLIB_BIN" 2>&1 || true
            
            # ã‚¢ãƒ—ãƒªæœ¬ä½“ãŒæŒã£ã¦ã„ã‚‹å¤ã„ãƒªãƒ³ã‚¯æƒ…å ±ã‚’å–å¾—
            OLD_REF=$(otool -L "$APP_BIN" | grep "libvo_se" | awk '{print $1}')
            
            if [ -n "$OLD_REF" ]; then
              echo "Fixing reference: $OLD_REF -> @executable_path/../Frameworks/bin/$LIB_NAME"
              # Macã®æ¨™æº–çš„ãªãƒ‘ã‚¹ã§ã‚ã‚‹Frameworkså†…ã‚’ç¬¬ä¸€å€™è£œã¨ã—ã¦ãƒªãƒ³ã‚¯
              install_name_tool -change "$OLD_REF" "@executable_path/../Frameworks/bin/$LIB_NAME" "$APP_BIN" 2>&1 || true
              # äºˆå‚™ã¨ã—ã¦ã€åŒã˜éšå±¤ã®binãƒ•ã‚©ãƒ«ãƒ€ã‚‚è©¦ã¿ã‚‹
              install_name_tool -change "$OLD_REF" "@loader_path/bin/$LIB_NAME" "$APP_BIN" 2>&1 || true
            else
              echo "Static reference not found. The app will load the library dynamically from its internal search path."
            fi
            
            # ç½²åã®ä¿®å¾©ï¼ˆã“ã‚Œã‚’ã—ãªã„ã¨ã‚²ãƒ¼ãƒˆã‚­ãƒ¼ãƒ‘ãƒ¼ã§å³æ­»ã—ã¾ã™ï¼‰
            codesign --force --deep --sign - "$DYLIB_BIN" 2>&1 || true
          done

          # 4. ã‚¢ãƒ—ãƒªæ§‹é€ å…¨ä½“ã‚’å†ç½²å
          echo "Final re-signing for the whole App Bundle..."
          codesign --force --deep --sign - "dist/VO-SE_PRO_Mac.app" 2>&1 || true

          # 5. æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆ
          echo "--- FINAL STATUS REPORT ---"
          ls -l "$APP_BIN"
          echo "Dependencies for $APP_BIN:"
          otool -L "$APP_BIN" | grep "lib"
          
          echo "Process finished. Ready for distribution."
          set -e
          
          
      - name: ğŸ” Startup Smoke Test (GUI Headless)
        shell: bash
        run: |
          echo "Starting startup test..."
          export QT_QPA_PLATFORM=offscreen
          export PYTHONIOENCODING=utf-8
          
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            echo "Running Windows Binary Check..."
            # çœç•¥ãªã—ã®Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
            python -c "
import os
import ctypes
import sys

# ãƒ‘ã‚¹ã®è§£æ±º
dll_path = os.path.abspath('bin/libvo_se.dll')
bin_dir = os.path.dirname(dll_path)

print(f'Target DLL Path: {dll_path}')
print(f'Checking directory: {bin_dir}')

# ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
if not os.path.exists(dll_path):
    print('Critical Error: libvo_se.dll not found in bin directory.')
    sys.exit(1)

# Windowsã®DLLæ¤œç´¢ãƒ‘ã‚¹ã¸ã®è¿½åŠ å‡¦ç†
if hasattr(os, 'add_dll_directory'):
    print('Detected Python 3.8+, using os.add_dll_directory')
    os.add_dll_directory(bin_dir)
else:
    print('Legacy Python detected, updating PATH environment variable')
    os.environ['PATH'] = bin_dir + os.pathsep + os.environ.get('PATH', '')

# å®Ÿéš›ã®ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
try:
    # ä¾å­˜é–¢ä¿‚ã‚’å«ã‚ã¦ãƒ­ãƒ¼ãƒ‰ã‚’è©¦è¡Œ
    lib = ctypes.CDLL(dll_path)
    print('SUCCESS: libvo_se.dll and its dependencies loaded successfully.')
except Exception as e:
    print('--- DLL Load Failure Report ---')
    print(f'Error Type: {type(e).__name__}')
    print(f'Error Message: {e}')
    print('Possible cause: Missing C++ Runtime or static linking failure.')
    sys.exit(1)
            "
            
            # ãƒ¡ã‚¤ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
            python -c "
import sys
import os
sys.path.append(os.getcwd())
try:
    import main
    print('SUCCESS: main.py and modules imported successfully.')
except Exception as e:
    print(f'Import Error: {e}')
    sys.exit(1)
            "
          else
            echo "Running macOS Binary Check..."
            # macOSå‘ã‘ã®çœç•¥ãªã—æ¤œè¨¼
            python -c "
import os
import ctypes
import sys
dylib_path = os.path.abspath('bin/libvo_se.dylib')
print(f'Checking macOS Dylib: {dylib_path}')
if not os.path.exists(dylib_path):
    print('Error: libvo_se.dylib not found.')
    sys.exit(1)
try:
    lib = ctypes.CDLL(dylib_path)
    print('SUCCESS: libvo_se.dylib loaded successfully.')
except Exception as e:
    print(f'macOS Load Error: {e}')
    sys.exit(1)
            "
            # macOSã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
            python -c "
import sys
import os
sys.path.append(os.getcwd())
try:
    import main
    print('SUCCESS: main.py imported successfully on macOS.')
except Exception as e:
    print(f'macOS Import Error: {e}')
    sys.exit(1)
            "
          fi

      - name: ğŸ“¦ Save Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VO-SE-PRO-Package-${{ matrix.os }}
          path: dist_out/
          
  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: VO-SE-PRO-Package-*
          merge-multiple: true
          path: dist_out

      - name: Show release files
        run: ls -la dist_out

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "VO-SE PRO (Official Edition)"
          fail_on_unmatched_files: false
          make_latest: true
          files: |
            dist_out/VO-SE_PRO_Win.exe
            dist_out/VO-SE_PRO_Mac.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
