name: "üöÄ Release VO-SE  Pro (Official Edition)"

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 1. ÂÖà„Å´„É©„Ç§„Éñ„É©„É™„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          python -m pip uninstall -y pkg_resources || true
          python -m pip install "setuptools>=70,<81" "pyinstaller==6.13.0"
          pip install PySide6 numpy sounddevice soundfile mido janome Pillow ruff pyright scipy onnxruntime chardet pykakasi backports.tarfile
          pip install pyopenjtalk --only-binary :all: || pip install pyopenjtalk

      - name: Verify pkg_resources for PyInstaller hook
        shell: python
        run: |
          import pkg_resources
          print("pkg_resources file:", getattr(pkg_resources, "__file__", "unknown"))
          print("has NullProvider:", hasattr(pkg_resources, "NullProvider"))
          if not hasattr(pkg_resources, "NullProvider"):
              raise SystemExit("pkg_resources.NullProvider is missing")

      # --- „Åì„Åì„Çí„ÇØ„É≠„Çπ„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†ÂØæÂøú„Å´‰øÆÊ≠£Ôºà‰∏ÄÂàá„ÅÆÁúÅÁï•„Å™„ÅóÔºâ ---
      - name: Create User Dictionary (if needed)
        shell: python # „Ç∑„Çß„É´„Å´python„ÇíÁõ¥Êé•ÊåáÂÆö„Åô„Çã„Åì„Å®„Åß„Ç®„É©„Éº„ÇíÂõûÈÅø
        run: |
          import os
          try:
              import pyopenjtalk
              if hasattr(pyopenjtalk, 'create_user_dict') and os.path.exists('user.csv'):
                  pyopenjtalk.create_user_dict('user.dic', 'user.csv')
                  print('User dictionary created successfully.')
              else:
                  print('Skip dict creation: No user.csv or function missing')
          except Exception as e:
              print(f'Skip dict creation: {e}')

      # 2. „Åù„ÅÆÂæå„Å´ Ruff „Åß„ÉÅ„Çß„ÉÉ„ÇØ
      - name: Lint with Ruff
        run: |
          ruff check . --select E,F --ignore E501

      # 3. ÊúÄÂæå„Å´ Pyright „Åß„ÉÅ„Çß„ÉÉ„ÇØ
      - name: Type Check with Pyright
        run: |
          pyright .

      - name: Pack Official Voice Data
        run: python modules/tools/pack_voice.py

      - name: Build C++ Engine
        shell: bash
        run: |
          mkdir -p bin
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            g++ -std=c++17 -shared -fPIC -o bin/libvo_se.dll src/vose_core.cpp src/world/*.cpp \
              -I. -Isrc -Iinclude -Iinclude/world -O2 -static-libgcc -static-libstdc++
          else
            clang++ -std=c++17 -shared -fPIC -o bin/libvo_se.dylib src/vose_core.cpp src/world/*.cpp \
              -I. -Isrc -Iinclude -Iinclude/world -undefined dynamic_lookup -O3 -w
          fi

      - name: Package App
        shell: bash
        run: |
          rm -rf dist build dist_out
          mkdir dist_out

          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            pyinstaller --noconsole --onefile --clean \
              --paths . \
              --paths modules \
              --icon="assets/icon.ico" \
              --hidden-import=modules.gui.main_window \
              --hidden-import=backports \
              --hidden-import=backports.tarfile \
              --add-data "bin/libvo_se.dll;bin" \
              --add-data "assets;assets" \
              --add-data "modules;modules" \
              --name "VO-SE_PRO_Win" main.py

            cp dist/VO-SE_PRO_Win.exe dist_out/
          else
            pyinstaller --noconsole --windowed --clean \
              --paths . \
              --paths modules \
              --icon="assets/icon.icns" \
              --exclude-module PySide6.QtPdf \
              --hidden-import=modules.gui.main_window \
              --hidden-import=backports \
              --hidden-import=backports.tarfile \
              --add-data "bin/libvo_se.dylib:bin" \
              --add-data "assets:assets" \
              --add-data "modules:modules" \
              --name "VO-SE_PRO_Mac" main.py

            chmod +x dist/VO-SE_PRO_Mac.app/Contents/MacOS/VO-SE_PRO_Mac
            cd dist && zip -ry ../dist_out/VO-SE_PRO_Mac.zip VO-SE_PRO_Mac.app && cd ..
          fi

      - name: üçé Verify and Fix macOS Library Linkage (Complete & Final)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          set +e
          echo "Mac„ÅÆ„Éê„Ç§„Éä„É™Ê®©Èôê‰ªò‰∏é„Å®„É™„É≥„ÇØ‰øÆÊ≠£„ÇíÂÆåÂÖ®ÂÆüË°å„Åó„Åæ„Åô..."
          
          # 1. „Ç¢„Éó„É™Êú¨‰Ωì„ÅÆÂÆüË°å„Éï„Ç°„Ç§„É´„ÇíÁâπÂÆö
          APP_BIN=$(find dist -name "VO-SE_PRO_Mac" -type f | grep "\.app/Contents/MacOS/VO-SE_PRO_Mac" | head -n 1)
          echo "Main Binary found at: $APP_BIN"

          # 2. Êú¨‰Ωì„Å´ÂÆüË°åÊ®©Èôê„Çí‰ªò‰∏é
          chmod +x "$APP_BIN"

          # 3. „Åô„Åπ„Å¶„ÅÆ dylib „Å´ÂØæ„Åó„Å¶‰∏ÄÊã¨Âá¶ÁêÜ
          # find„ÅÆÁµêÊûú„ÇíÁ¢∫ÂÆü„Å´1„Å§„Åö„Å§Âá¶ÁêÜ„Åô„Çã„Åü„ÇÅ„Å´while read„Çí‰ΩøÁî®
          find dist -name "libvo_se.dylib" -type f | while read -r DYLIB_BIN; do
            echo "--- Processing: $DYLIB_BIN ---"
            
            # Ê®©Èôê„ÇíÊúÄÂº∑„ÅÆ755ÔºàË™≠„Åø„ÉªÊõ∏„Åç„ÉªÂÆüË°åÔºâ„Å´Ë®≠ÂÆö
            chmod 755 "$DYLIB_BIN"
            
            # dylibËá™Ë∫´„ÅÆÂÜÖÈÉ®Âêç„Çí„Äå„Éï„Ç°„Ç§„É´Âêç„Å†„Åë„Äç„Å´Êõ∏„ÅçÊèõ„Åà„Å¶„Å©„Åì„Åã„Çâ„Åß„ÇÇÂëº„Åπ„Çã„Çà„ÅÜ„Å´„Åô„Çã
            LIB_NAME=$(basename "$DYLIB_BIN")
            install_name_tool -id "$LIB_NAME" "$DYLIB_BIN" 2>&1 || true
            
            # „Ç¢„Éó„É™Êú¨‰Ωì„ÅåÊåÅ„Å£„Å¶„ÅÑ„ÇãÂè§„ÅÑ„É™„É≥„ÇØÊÉÖÂ†±„ÇíÂèñÂæó
            OLD_REF=$(otool -L "$APP_BIN" | grep "libvo_se" | awk '{print $1}')
            
            if [ -n "$OLD_REF" ]; then
              echo "Fixing reference: $OLD_REF -> @executable_path/../Frameworks/bin/$LIB_NAME"
              # Mac„ÅÆÊ®ôÊ∫ñÁöÑ„Å™„Éë„Çπ„Åß„ÅÇ„ÇãFrameworksÂÜÖ„ÇíÁ¨¨‰∏ÄÂÄôË£ú„Å®„Åó„Å¶„É™„É≥„ÇØ
              install_name_tool -change "$OLD_REF" "@executable_path/../Frameworks/bin/$LIB_NAME" "$APP_BIN" 2>&1 || true
              # ‰∫àÂÇô„Å®„Åó„Å¶„ÄÅÂêå„ÅòÈöéÂ±§„ÅÆbin„Éï„Ç©„É´„ÉÄ„ÇÇË©¶„Åø„Çã
              install_name_tool -change "$OLD_REF" "@loader_path/bin/$LIB_NAME" "$APP_BIN" 2>&1 || true
            else
              echo "Static reference not found. The app will load the library dynamically from its internal search path."
            fi
            
            # ÁΩ≤Âêç„ÅÆ‰øÆÂæ©Ôºà„Åì„Çå„Çí„Åó„Å™„ÅÑ„Å®„Ç≤„Éº„Éà„Ç≠„Éº„Éë„Éº„ÅßÂç≥Ê≠ª„Åó„Åæ„ÅôÔºâ
            codesign --force --deep --sign - "$DYLIB_BIN" 2>&1 || true
          done

          # 4. „Ç¢„Éó„É™ÊßãÈÄ†ÂÖ®‰Ωì„ÇíÂÜçÁΩ≤Âêç
          echo "Final re-signing for the whole App Bundle..."
          codesign --force --deep --sign - "dist/VO-SE_PRO_Mac.app" 2>&1 || true

          # 5. ÊúÄÁµÇ„É¨„Éù„Éº„Éà
          echo "--- FINAL STATUS REPORT ---"
          ls -l "$APP_BIN"
          echo "Dependencies for $APP_BIN:"
          otool -L "$APP_BIN" | grep "lib"
          
          echo "Process finished. Ready for distribution."
          set -e
          
          
      - name: üîç Startup Smoke Test (GUI Headless)
        shell: bash
        run: |
          echo "Starting startup test..."
          export QT_QPA_PLATFORM=offscreen
          export PYTHONIOENCODING=utf-8

          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            echo "Running Windows Binary Check (src/include/bin structure)..."
            # ÊîπË°å„Çí„Éê„ÉÉ„ÇØ„Çπ„É©„ÉÉ„Ç∑„É•„ÅßÁπã„Åé„ÄÅ„Ç§„É≥„Éá„É≥„Éà„ÇíÁ∂≠ÊåÅ„Åó„Åü„Åæ„ÅæPython„Å´Ê∏°„Åô
            python -c "
            import os, ctypes, sys; \
            root_dir = os.path.abspath(os.getcwd()); \
            bin_dir = os.path.join(root_dir, 'bin'); \
            src_dir = os.path.join(root_dir, 'src'); \
            dll_path = os.path.join(bin_dir, 'libvo_se.dll'); \
            print(f'Target: {dll_path}'); \
            os.environ['PATH'] = bin_dir + os.pathsep + os.environ.get('PATH', ''); \
            if hasattr(os, 'add_dll_directory'): os.add_dll_directory(bin_dir); \
            os.chdir(bin_dir); \
            try: \
                lib = ctypes.CDLL('./libvo_se.dll'); \
                print('SUCCESS: DLL Loaded'); \
            except Exception as e: \
                print(f'DLL Error: {e}'); sys.exit(1); \
            os.chdir(root_dir); \
            sys.path.extend([root_dir, src_dir]); \
            try: \
                import main; \
                print('SUCCESS: App Import Passed'); \
            except Exception as e: \
                print(f'Import Error: {e}'); sys.exit(1); \
            "
          else
            echo "Running macOS Binary Check..."
            python -c "
            import os, ctypes, sys; \
            root_dir = os.path.abspath(os.getcwd()); \
            src_dir = os.path.join(root_dir, 'src'); \
            dylib_path = os.path.join(root_dir, 'bin', 'libvo_se.dylib'); \
            try: \
                lib = ctypes.CDLL(dylib_path); \
                print('SUCCESS: Dylib Loaded'); \
            except Exception as e: \
                print(f'Error: {e}'); sys.exit(1); \
            sys.path.extend([root_dir, src_dir]); \
            import main; \
            print('SUCCESS: macOS Import Passed'); \
            "
          fi

          

          
      - name: üì¶ Save Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VO-SE-PRO-Package-${{ matrix.os }}
          path: dist_out/
          
  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: VO-SE-PRO-Package-*
          merge-multiple: true
          path: dist_out

      - name: Show release files
        run: ls -la dist_out

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "VO-SE PRO (Official Edition)"
          fail_on_unmatched_files: false
          make_latest: true
          files: |
            dist_out/VO-SE_PRO_Win.exe
            dist_out/VO-SE_PRO_Mac.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
