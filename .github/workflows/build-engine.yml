name: Build VO-SE Pro

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip' # キャッシュを利用して2回目以降を高速化

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build C Engine DLL
      shell: powershell
      run: |
        # 出力先のbinフォルダを作成（既にあってもエラーにしない）
        if (!(Test-Path "bin")) { New-Item -ItemType Directory -Path "bin" }
        
        # Cソースが存在するか確認してからビルド
        if (Test-Path "src/vo_se_engine.c") {
          gcc -shared -o bin/libvo_se.dll src/vo_se_engine.c
          echo "C Engine built successfully."
        } else {
          echo "Error: src/vo_se_engine.c not found."
          exit 1
        }

    - name: Run PyInstaller
      run: |
        # vose_pro.spec を使ってビルド
        pyinstaller vose_pro.spec

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: VO-SE_Pro_Windows_Package
        # distフォルダ内の完成品をまるごとアップロード
        path: dist/VO-SE_Pro/
        retention-days: 5
