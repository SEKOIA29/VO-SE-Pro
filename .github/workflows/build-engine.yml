- name: Setup Open JTalk for Intonation Analysis
      shell: powershell
      run: |
        # 安定した配布元（SourceForgeのミラーなど）から取得を試みる、または代替URL
        # ここでは、比較的人気のあるGitHubミラーを指定
        $url = "https://github.com/r9y9/open_jtalk/releases/download/v1.11/open_jtalk-1.11-win64-msvc.zip"
        
        try {
            Write-Host "Downloading Open JTalk from $url..."
            Invoke-WebRequest -Uri $url -OutFile "jtalk.zip" -ErrorAction Stop
        } catch {
            Write-Warning "Primary URL failed. Trying fallback..."
            # 予備のURL（必要に応じて調整）
            $url = "https://github.com/shift-jis/open_jtalk-win/releases/download/v1.11/open_jtalk-v1.11-win-x64.zip"
            Invoke-WebRequest -Uri $url -OutFile "jtalk.zip"
        }

        Expand-Archive -Path "jtalk.zip" -DestinationPath "bin/jtalk_temp" -Force
        
        # 実行ファイルと辞書を配置（解凍後のフォルダ構造に合わせて柔軟に移動）
        $exePath = Get-ChildItem -Path "bin/jtalk_temp" -Filter "open_jtalk.exe" -Recurse | Select-Object -First 1
        $dicPath = Get-ChildItem -Path "bin/jtalk_temp" -Name "dic" -Directory -Recurse | Select-Object -First 1
        
        if ($exePath) { 
            Copy-Item -Path $exePath.FullName -Destination "bin/open_jtalk/open_jtalk.exe" -Force 
        }
        # 辞書フォルダを再帰的にコピー
        $fullDicPath = Get-ChildItem -Path "bin/jtalk_temp" -Filter "dic" -Directory -Recurse | Select-Object -First 1
        if ($fullDicPath) {
            Copy-Item -Path "$($fullDicPath.FullName)/*" -Destination "bin/open_jtalk/dic" -Recurse -Force
        }

        Remove-Item -Path "jtalk.zip"
        Remove-Item -Path "bin/jtalk_temp" -Recurse
        Write-Host "Open JTalk Setup Complete."
