name: "ğŸ™ï¸ VO-SE Pro: Official Engine Builder (Final)"

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: "ğŸ› ï¸ Build & Pack on ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest]

    steps:
      - name: "ğŸ“‚ [Step 1] Checkout Repository"
        uses: actions/checkout@v4

      - name: "ğŸ [Step 2] Setup Python Environment"
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: "ğŸ“¦ [Step 3] Install Python Dependencies"
        run: pip install numpy

      # --- ç’°å¢ƒæº–å‚™ ---
      - name: "ğŸ“ [Step 4] Prepare Binary Directory (Windows)"
        if: matrix.os == 'windows-latest'
        run: |
          if (-not (Test-Path "bin")) { New-Item -ItemType Directory -Path "bin" | Out-Null }
          if (-not (Test-Path "src")) { New-Item -ItemType Directory -Path "src" | Out-Null }

      - name: "ğŸ“ [Step 4] Prepare Binary Directory (MacOS)"
        if: matrix.os == 'macos-latest'
        run: mkdir -p bin src

      # --- å…¬å¼éŸ³æºã®ãƒ‘ãƒƒã‚­ãƒ³ã‚° (modules/tools/é…ä¸‹ã‚’æ­£ç¢ºã«å‚ç…§) ---
      - name: "ğŸ™ï¸ [Step 5] Pack Official Voice Data"
        run: |
          # ä»£è¡¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã€Œmodules/tools/ã€ã‚’æ­£ç¢ºã«å©ãã¾ã™
          python modules/tools/pack_voice.py 
        # ã“ã‚Œã§ src/voice_data.h ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™

      # --- Windowsãƒ“ãƒ«ãƒ‰ (MinGW/GCC) ---
      - name: "ğŸ—ï¸ [Step 6] Compile Engine (Windows)"
        if: matrix.os == 'windows-latest'
        run: |
          Write-Host "ğŸ”¨ Compiling vose_core.dll with C++17..." -ForegroundColor Cyan
          g++ -std=c++17 -O3 -Wall -shared -fPIC -DVOSE_OFFICIAL_RELEASE -o bin/vose_core.dll `
            src/vose_core.cpp `
            src/world/*.cpp `
            -Iinclude `
            -Iinclude/world `
            -static-libgcc -static-libstdc++
          Write-Host "âœ… Windows DLL Build Complete!" -ForegroundColor Green

      # --- MacOSãƒ“ãƒ«ãƒ‰ (Clang) ---
      - name: "ğŸ—ï¸ [Step 6] Compile Engine (MacOS)"
        if: matrix.os == 'macos-latest'
        run: |
          echo "ğŸ”¨ Compiling vose_core.dylib with C++17..."
          clang++ -std=c++17 -O3 -Wall -shared -fPIC -DVOSE_OFFICIAL_RELEASE -o bin/vose_core.dylib \
            src/vose_core.cpp \
            src/world/*.cpp \
            -Iinclude \
            -Iinclude/world \
            -undefined dynamic_lookup
          echo "âœ… MacOS Dylib Build Complete!"

      # --- æˆæœç‰©ã®ä¿å­˜ ---
      - name: "ğŸ“¦ [Step 7] Archive and Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: vose-official-engine-${{ matrix.os }}
          path: bin/
          retention-days: 7
