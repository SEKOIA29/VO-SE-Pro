name: Build VO-SE Pro

on: [push]

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Workspace
      run: |
        mkdir -p bin/open_jtalk
        mkdir -p src

    # ここでGitHubのサーバーが直接バイナリを取得します（あなたの操作は不要）
    - name: Install Open JTalk Binary
      shell: powershell
      run: |
        $url = "https://github.com/r9y9/open_jtalk/releases/download/v1.11/open_jtalk-1.11-win64-msvc.zip"
        Invoke-WebRequest -Uri $url -OutFile "jtalk.zip"
        Expand-Archive -Path "jtalk.zip" -DestinationPath "jtalk_temp"
        # 必要なファイルだけを抽出して配置
        Move-Item "jtalk_temp/bin/open_jtalk.exe" "bin/open_jtalk/"
        Move-Item "jtalk_temp/dic" "bin/open_jtalk/"
        Remove-Item "jtalk_zip", "jtalk_temp" -Recurse

    - name: Build C-Engine
      run: |
        if (Test-Path "src/vo_se_engine.c") {
          gcc -shared -o bin/libvo_se.dll src/vo_se_engine.c
        }

    - name: Run PyInstaller
      run: |
        pip install pyinstaller -r requirements.txt
        pyinstaller vose_pro.spec

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: VO-SE_Pro_Full_Package
        path: dist/VO-SE_Pro/
